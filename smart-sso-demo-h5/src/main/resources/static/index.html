<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>smart-sso-demo-h5</title>
</head>
<body>
<h2>smart-sso-demo-h5</h2>

<br/><b>用户名</b>：<span id="_username"></span><br/>

<br/><b>用户已分配的菜单</b>：<span id="_userMenus"></span>

<br/><b>用户已分配的权限</b>：<span id="_userPermissions"></span>

<br/><a href="javascript:goSsoLogoutUrl()">单点退出</a>
</body>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>window.jQuery || alert('jQuery.js未加载成功，请检查网络或更换CDN')</script>
<script type="text/javascript">
        // 后端接口地址
		var baseUrl = "http://demo.smart-sso.com:8082";
		$(function() {
		    if(validateLogin()){
		        smart.ajax('GET', baseUrl + "/userinfo", {}, true, function(res) {
                    var userinfo = res.data;

                    // 用户名
                    $("#_username").html(userinfo.username);

                    // 用户已分配的菜单
                    var userMenus = '';
                    userinfo.userMenus.forEach(function(menu) {
                        userMenus += '<li>' + menu + '</li>';
                    });
                    $('#_userMenus').html(userMenus);

                    // 用户已分配的权限
                    var userPermissions = '';
                    userinfo.userPermissions.forEach(function(permission) {
                        userPermissions += '<li>' + permission + '</li>';
                    });
                    $('#_userPermissions').html(userPermissions);
                });
		    }
        })

        // 校验是否需要跳转到认证中心
        function validateLogin(){
            var accessToken = localStorage.getItem("accessToken");
            if(accessToken) {
                return true;
            }
            var code = getParam('code');
            if(code && getAccessToken(code)) {
                return true;
            }
            goSsoLoginUrl();
            return false;
        }

        // 重定向至认证中心
        function goSsoLoginUrl() {
            $.getJSON(baseUrl + '/auth/login_url?redirectUri=' + location.href, function(res) {
                window.location.href = res.data;
            })
        }

        // 重定向至服务端退出地址
        function goSsoLogoutUrl() {
            $.getJSON(baseUrl + '/auth/logout_url?redirectUri=' + location.href, function(res) {
                window.location.href = res.data;
            })
        }

        // 获取accessToken
        function getAccessToken(code){
            var bool = false;
            $.ajax({
                url: baseUrl + "/auth/access_token?code=" + code,
                type: 'GET',
                async: false,
                dataType: 'json',
                success: function(res){
                    if(res.code == 1){
                        localStorage.setItem("accessToken", res.data.accessToken);
                        localStorage.setItem("refreshToken", res.data.refreshToken);
                        removeCodeParamAndRedirect();
                        bool = true;
                    }
                    else {
                        goSsoLoginUrl();
                    }
                }
            });
            return bool;
        }

        // 获取refreshToken
        function getRefreshToken(){
            var bool = false;
            $.ajax({
                url: baseUrl + "/auth/refresh_token?refreshToken=" + localStorage.getItem("refreshToken"),
                type: 'GET',
                async: false,
                dataType: 'json',
                success: function(res){
                    if(res.code == 1){
                        localStorage.setItem("accessToken", res.data.accessToken);
                        localStorage.setItem("refreshToken", res.data.refreshToken);
                        bool = true;
                    }
                    else {
                        goSsoLoginUrl();
                    }
                }
            });
            return bool;
        }

        // 从url中查询到指定名称的参数值
        function getParam(name, defaultValue){
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i=0;i<vars.length;i++) {
                var pair = vars[i].split("=");
                if(pair[0] == name){return pair[1];}
            }
            return (defaultValue == undefined ? null : defaultValue);
        }

        // 重定向方式去除地址栏中的code参数
        function removeCodeParamAndRedirect() {
          var url = new URL(window.location.href);
          url.searchParams.delete('code');
          window.location.href = url.toString();
        }
</script>
<script type="text/javascript">
    var smart = {};
    // 为业务请求封装Ajax方法，请求头自动附带token，请求返回处理token刷新和失效跳转等逻辑
    smart.ajax = function(method, url, data, async, successFn) {
        $.ajax({
            url: url,
            type: method,
            data: data,
            async: async,
            dataType: 'json',
            headers: {
                'smart-sso-token': localStorage.getItem("accessToken"),
                // 跨域请求需自行设置X-Requested-With参数，Ajax仅在非跨域请求默认携带
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(res){
                // 响应成功
                if(res.code == 1){
                    successFn(res);
                }
                // 后端登录失效，需要清理前端缓存，并跳转至认证中心
                else if (res.code == 10){
                    localStorage.clear();
                    goSsoLoginUrl();
                }
                /**
                 * accessToken已过期，refreshToken已过期，客户端需要调用refreshToken刷新accessToken
                 * 1、如果refreshToken成功，之前因为accessToken过期请求失败的接口再发起一遍
                 * 2、否则，跳转至认证中心
                 */
                else if (res.code == 15){
                    if(getRefreshToken()){
                        smart.ajax(method, url, data, async, successFn);
                    }
                    else {
                        goSsoLoginUrl();
                    }
                }
                // 其它异常，弹出提示
                else {
                    alert(res.message);
                }
            },
            error: function(xhr, type, errorThrown){
                alert(JSON.stringify(xhr));
            }
        });
    }
</script>
</html>